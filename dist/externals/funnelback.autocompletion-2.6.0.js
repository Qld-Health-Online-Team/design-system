(function($){"use strict";var autocompletion=function(t,e){this.$element=$(t),this.options=e,this.init()};autocompletion.defaults={datasets:null,callback:null,debounceDelay:300,group:!1,groupOrder:[],facets:{blacklist:[],whitelist:[],show:2,url:null},itemGroup:"category",itemLabel:"value",template:{group:function(t){return $("<div>").html(String(t.label))},suggestion:function(t){return $("<div>").html(String(t.label))}},templateMerge:!0,transform:_processSetData,collection:null,dataType:"json",alpha:"0.5",format:"extended",params:null,profile:"_default",program:"/s/suggest.json",show:10,sort:0,queryKey:"partial_query",queryVal:"%QUERY",length:3,horizontal:!1,scrollable:!1,logging:!0,interactionLog:"/s/log",typeahead:{classNames:{},highlight:!0,hint:!1,events:{select:function(t,e){_selectItem(e,$(t.target))},afterselect:function(t,e){"E"==e.extra.action_t&&$(t.target).focus()}}}},autocompletion.prototype.init=function(){this.option(this.options),_isEnabled(this.options)?this.initTypeahead():this.destroy()},autocompletion.prototype.destroy=function(){this.destroyTypeahead,this.$element=null,this.options={}},autocompletion.prototype.option=function(t,e){if(0===arguments.length)return this.options;var a=this,n=$.isObject(t)?t:{};if($.isString(t)){if(1===arguments.length||!$.isDefinied(e))return $.dataVals($.extend({},a.options),t);n[t]=e}for(var o in n)i(o,n[o]);function i(t,e){"datasets"===t&&(a.options[t]=_mapOptions(a.options,e)),"debug"===t&&(_debug=e),"horizontal"===t&&e&&(a.setTypeaheadClass("menu","tt-horizontal"),a.options.typeahead.events.render=function(t){_renderSetWidth(a.getTypeaheadMenu(),"tt-horizontal","tt-dataset")}),"scrollable"===t&&e&&a.setTypeaheadClass("menu","tt-scrollable")}},autocompletion.prototype.horizontal=function(t){return this.option("horizontal",t)},autocompletion.prototype.scrollable=function(t){return this.option("scrollable",t)},autocompletion.prototype.initTypeahead=function(){var t=this,e=[];if($.each(t.options.datasets,(function(t,a){e.push(_getSetData(a,t))})),t.$element.typeahead({minLength:parseInt(t.options.length),hint:t.options.typeahead.hint,highlight:t.options.typeahead.highlight,classNames:t.options.typeahead.classNames},e),t.options.typeahead.events&&$.each(t.options.typeahead.events,(function(e,a){t.$element.on("typeahead:"+e,a)})),t.options.horizontal){e=t.$element.data();var a=t.getTypeaheadMenu();e.ttTypeahead._onDownKeyed=function(){_navCursorUD(40,a,t.$element)},e.ttTypeahead._onUpKeyed=function(){_navCursorUD(38,a,t.$element)};var n=a.children(".tt-dataset");n.size()>1&&(e.ttTypeahead._onLeftKeyed=function(){_navCursorLR(37,n,t.$element)},e.ttTypeahead._onRightKeyed=function(){_navCursorLR(39,n,t.$element)}),t.$element.on("keydown",(function(t){var e=t.keyCode||t.which;return 38!=e&&40!=e&&((37!=e&&39!=e||!$.exist(_navCols.cursor))&&void 0)}))}t.options.logging&&t.$element.on("typeahead:select",(function(e,a){logInteraction(t.options,a,$(e.target),"select")}))},autocompletion.prototype.destroyTypeahead=function(){this.$element.typeahead("destroy")},autocompletion.prototype.getTypeaheadMenu=function(){return this.$element.siblings(".tt-menu")},autocompletion.prototype.setTypeaheadClass=function(t,e){$.exist(this.options.typeahead.classNames[t],!0)||(this.options.typeahead.classNames[t]="tt-"+t),this.options.typeahead.classNames[t]+=" "+e};var _debug=!1,_mapKeys=["collection","callback","dataType","alpha","facets","transform","format","group","groupOrder","itemGroup","itemLabel","params","profile","program","show","sort","queryKey","queryVal","template","templateMerge","debounceDelay"],_navCols={cursor:null,query:""};function _isEnabled(t){var e=!1;return $.isObject(t.datasets)?($.each(t.datasets,(function(t,a){$.exist(a.collection,!0)&&(e=!0)})),e):e}function _mapOptions(t,e){var a={};return $.each(_mapKeys,(function(e,n){a[n]=t[n]})),$.each(e,(function(t,n){e[t]=$.extend(!0,{},a,n)})),e}function _getSetData(t,e){var a=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("value"),queryTokenizer:Bloodhound.tokenizers.whitespace,remote:function(){var a={url:t.url?t.url:_getSetUrl(t),filter:function(a){var n,o=(n=$(this).get(0).transport.lastReq,$.exist(n,!0)?(n=decodeURIComponent(n)).substring(n.lastIndexOf(t.queryKey+"=")+(t.queryKey.length+1),n.lastIndexOf("GET")):n);return _handleSetData(t,$.map(a,(function(a,n){return t.transform(t,a,n,e,o)})))},rateLimitWait:t.debounceDelay};"jsonp"===t.dataType?a.prepare=function(e,a){return a.dataType="jsonp",a.url=a.url.replace(t.queryVal,e),a}:a.wildcard=t.queryVal;return a}()});return a.initialize(),{name:e,limit:1e4,source:function(e,n,o){if(e.length<1&&t.defaultCall)if($.isString(t.defaultCall))e=t.defaultCall;else{if($.isArray(t.defaultCall))return void n(_handleSetData(t,t.defaultCall));if($.exist(t.defaultCall.data))return void n(_handleSetData(t,t.defaultCall.transform(t,t.defaultCall.data)));$.exist(t.defaultCall.url,!0)&&$.get(t.defaultCall.url,t.defaultCall.params,(function(e){o(_handleSetData(t.defaultCall.transform(t,e)))}))}a.search(e,n,o)},display:function(e){return $.isFunction(t.itemLabel)?t.itemLabel.call(void 0,e):$.dataVals(e,t.itemLabel)},templates:_renderSetTemplate(t)}}function _getSetUrl(t){var e={collection:t.collection};return $.exist(t.format,!0)&&(e.fmt="simple"==t.format?"json":"json++"),$.exist(t.alpha,!0)&&(e.alpha=t.alpha),$.exist(t.profile,!0)&&(e.profile=t.profile),$.exist(t.show,!0)&&(e.show=t.show),$.exist(t.sort,!0)&&(e.sort=t.sort),$.isObject(t.param)&&(e=$.extend(!0,{},e,t.params)),t.program+"?"+$.param(e)+"&"+t.queryKey+"="+t.queryVal}function _groupSetData(t,e){var a,n,o={"":[]};if($.exist(t.groupOrder))for(a=0,n=t.groupOrder.length;a<n;a++)o[t.groupOrder[a]]=[{label:t.groupOrder[a]}];for(a=0,n=e.length;a<n;a++)$.exist(o[e[a][t.itemGroup]])||(o[e[a][t.itemGroup]]=[{label:e[a][t.itemGroup]}]),o[e[a][t.itemGroup]].push(e[a]);return e=[],$.each(o,(function(t,a){a.length>1&&($.exist(t,!0)||a.splice(0,1),$.merge(e,a))})),e}function _handleSetData(t,e){return e=e.slice(0,t.show),t.callback&&$.isFunction(t.callback)&&(e=t.callback.call(void 0,t,e)||[]),t.group?_groupSetData(t,e):e}function _processSetData(t,e,a,n,o){return $.autocompletion.processSetData(t,e,a,n,o)}function _renderSetWidth(t,e,a){var n,o,i=0,l=0,r=t.width();if(a="."+a,e="."+e,$.each(t.children(a),(function(){o=$(this).attr("class").split(" "),(n=$.cssStyle(e+" ."+o[1])||$.cssStyle(e+" ."+o.join("."))).width&&n.width.indexOf("important")&&n.width.indexOf("auto")<0&&n.width.indexOf("initial")<0&&n.width.indexOf("inherit")<0?n.width.indexOf("%")>0?l+=r*parseFloat(n.width)/100:l+=parseFloat(n.width):$.hasContent($(this))&&i++})),i){r-=l+.5;var s=parseFloat(t.children(a).css("min-width")),u=r/i;s<=u&&t.children(a).css("width",u+"px")}}function _renderSetTemplate(t){return _setSetTemplateHeader(t),!t.template||$.isEmptyObject(t.template)?{}:($.each(t.template,(function(e,a){$.isObject(a)&&(t.template[e]=a.prop("outerHTML"))})),t.templateMerge&&(e("notFound"),e("pending")),$.each(t.template,(function(e,a){$.isString(a)&&(t.template[e]=Handlebars.compile(a))})),t.template);function e(e){t.template[e]&&$.isString(t.template[e])&&(t.template.header&&$.isString(t.template.header)&&(t.template[e]=t.template.header+t.template[e]),t.template.footer&&$.isString(t.template.footer)&&(t.template[e]+=t.template.footer))}}function _setSetTemplateHeader(t){!t.template.header&&$.exist(t.name,!0)&&(t.template.header='<h5 class="tt-category">'+t.name+"</h5>")}function _selectItem(item,target){if($.exist(item.extra))switch(item.extra.action_t){case"C":eval(item.extra.action);break;case"U":document.location=item.extra.action;break;case"E":target.typeahead("val",item.extra.action);break;default:formSend(item.value)}else formSend(item.value);function formSend(t){target.val(t),target.closest("form").submit()}}function _getSelectableLabel(t){return $.exist(t.data())?t.data().ttSelectableDisplay:t.text()}function _navCursorLR(t,e,a){if($.exist(_navCols.cursor)){var n=_navCols.cursor.parent(),o=e.index(n),i=function a(n){var o=37==t?$.exist(e[n-1])?n-1:e.length-1:$.exist(e[n+1])?n+1:0,i=$(e[o]).children(".tt-selectable");return $.exist(i)?i:a(o)}(o),l=$(n).children(".tt-selectable").index(_navCols.cursor),r=$.exist(i[l])?i[l]:i[i.length-1];$(_navCols.cursor).removeClass("tt-cursor"),_navCols.cursor=$(r).addClass("tt-cursor"),a.data().ttTypeahead.input.setInputValue(_getSelectableLabel(_navCols.cursor))}}function _navCursorUD(t,e,a){if(!$.exist(e.find(".tt-cursor")))return _navCols.cursor=38==t?e.find(".tt-selectable").last():e.find(".tt-selectable").first(),_navCols.cursor.addClass("tt-cursor"),_navCols.query=a.val(),void a.data().ttTypeahead.input.setInputValue(_getSelectableLabel(_navCols.cursor));var n=_navCols.cursor.parent(),o=$(n).children(".tt-selectable");if($.exist(o)){var i=o.index(_navCols.cursor),l=38==t?-1:1;$(_navCols.cursor).removeClass("tt-cursor"),$.exist(o[i+l])?(_navCols.cursor=$(o[i+l]).addClass("tt-cursor"),a.data().ttTypeahead.input.setInputValue(_getSelectableLabel(_navCols.cursor))):(_navCols.cursor=null,a.data().ttTypeahead.input.resetInputValue(),a.data().ttTypeahead._updateHint())}}function logDebug(t,e,a,n){_debug&&window.console&&(console.log(n),console.log("Options: ",t),console.log("Input: ",e),console.log("Output: ",a),console.log("--------"))}function logInteraction(t,e,a,n){t.logging&&$.exist(t.interactionLog,!0)&&e.dataset&&t.datasets[e.dataset]&&$.ajax({dataType:"jsonp",type:"GET",url:function(e,a){var o={collection:e.collection,type:n,partial_query:a.query,client_time:(new Date).getTime()};$.exist(e.profile,!0)&&(o.profile=e.profile);$.exist(a.extra)&&(o=$.extend(!0,{},o,a.extra));return t.interactionLog+"?"+$.param(o)}(t.datasets[e.dataset],e)}).fail((function(a,n,o){logDebug(t,e,a,"Interaction log error: "+n+" "+o)}))}function Plugin(){var t=[].slice.call(arguments),e=t.shift();return this.each((function(){var a=$(this),n=a.data("flb.autocompletion"),o=$.extend(!0,{},autocompletion.defaults,n||{},$.isObject(e)&&e);!n&&/destroy|hide/.test(e)||(n||a.data("flb.autocompletion",n=new autocompletion(this,o)),$.isString(e)&&$.isFunction(n[e])&&n[e].apply(a,t))}))}$.fn.autocompletion=Plugin,$.fn.autocompletion.Constructor=autocompletion,$.autocompletion={processSetData:function(set,suggestion,i,name,query){var value=suggestion.key,label=suggestion.key;return"Q"==suggestion.action_t&&(value=suggestion.action),"S"==suggestion.action_t&&(value=suggestion.disp),"C"==suggestion.disp_t?label=eval(suggestion.disp):suggestion.disp&&(label=suggestion.disp),{label:label,value:value,extra:suggestion,category:suggestion.cat?suggestion.cat:"",rank:i+1,dataset:name,query:query}},processSetDataFacets:function(t,e,a,n,o){if("response"===a&&$.exist(e.facets)){for(var i=[],l=1,r=(a=0,e.facets.length);a<r;a++){var s=e.facets[a];if($.exist(s.allValues)&&!($.exist(t.facets.blacklist)&&t.facets.blacklist.indexOf(s.name)>-1||$.exist(t.facets.whitelist)&&t.facets.whitelist.indexOf(s.name)<0))for(var u=0,c=s.allValues.length;u<c&&!($.exist(t.facets.show)&&u>parseInt(t.facets.show)-1);u++)s.allValues[u].count&&i.push({label:s.allValues[u].label,value:s.allValues[u].data,extra:{action:p(s.allValues[u]),action_t:"U"},category:s.name,rank:l++,dataset:n,query:o})}return i}function p(e){return($.exist(t.facets.url,!0)?t.facets.url:window.location.origin+window.location.pathname)+e.toggleUrl}}},$.exist=function(t,e){$.isDefinied(e)||(e=!1);t=e?t:$(t);return $.isDefinied(t)&&null!=t&&($.isString(t)?t+"":t).length>0},$.hasContent=function(t){return!!t.html().trim().length},$.isDefinied=function(t){return void 0!==t},$.isFunction=function(t){return"function"==typeof t},$.isString=function(t){return"string"==typeof t},$.isObject=function(t){return"object"==typeof t},$.dataKeys=function(t){return function t(e,a){return $.map(Object.keys(e),(function(n){return e[n]&&$.isObject(e[n])?t(e[n],n):a?a+"-"+n:n}))}(t,"")},$.dataVals=function(t,e){var a=e.split(".");e=a.shift();if(a.length)for(var n=0,o=a.length;n<o;n++)t=t[e]||{},e=a[n];return t[e]},$.cssStyle=function(t){for(var e=window.document.styleSheets,a={},n=0,o=e.length;n<o;n++)if(!(e[n].href&&e[n].href.indexOf(window.location.host)<0)){var i=e[n].rules||e[n].cssRules;if(i)for(var l=0,r=i.length;l<r;l++)if(i[l].selectorText==t)for(var s=i[l].style.cssText.split(";"),u=0,c=s.length;u<c;u++){var p=s[u].split(":");2==p.length&&(a[p[0].trim()]=p[1].trim())}}return a}})(jQuery),String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};